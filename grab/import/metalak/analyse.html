<body>
  <div></div>
  <script>
    (async function start(){
      var div = document.querySelector('div');
      let list = await fetch('list.json').then( response => response.json() );

      let product = await fetch('../../../product.json').then( response => response.json() );
      // let data = await fetch('data.json').then( response => response.json() );
      for (let url in list) {
        row = list[url];
        if (row &&
        // !row.data &&
        row.url && row.url.match(/artcode/)) {
          var pageurl = row.url.replace(/^.*?artcode=/, 'pages/')+'.html';
          // return console.log(url);
          try {
            div.innerHTML = await fetch(pageurl).then( response => response.text() );
            var table1 = Array.from(div.children).find(e => e.tagName==='TABLE');
            // querySelectorAll('table')).find(e => e.querySelector('tbody') && e.querySelector('tbody').querySelector('tbody'));
            // var tbody2 = tbody1.querySelector('tbody');
            // console.log(table1);
            var artcode = div.querySelector('.spnProductDetailArtcode').innerText;
            var prod = product.find(prod => prod.artcode === artcode);
            if (!prod) product.push(prod = {artcode: artcode});
            Object.assign(prod, {
              schemaName: 'supplierproduct',
              path: div.querySelector('#detail_breadcrumb').innerText.split('>'),
              barcode: div.innerText.split(/Barcode: /).pop().split(/\n/).shift(),
              images: Array.from(div.querySelectorAll('img')).map(e => e.src.replace(/\?.*/, '').replace(/.*?webshop_detail\/\//, 'https://proving.aliconnect.nl/assets/ml/webfiles/webshop_detail/')  ).filter(src => src.match(/webshop_detail/)),
              // title: table1.querySelector('tbody').querySelector('tbody').querySelector('tbody').children[1].innerText,
              detail: div.querySelector('.bigdescriptionhtmldetail').innerHTML.trim(),
              title: div.querySelector('.bigdescriptionhtmldetail').parentElement.parentElement.previousElementSibling.innerText,
            })
          } catch (err) {
            console.log(err);
            list[url] = null;

          }
          // console.log(prod);
          // data.push(rowdata);
          // return;
        }
      }
      console.log(product);
      await fetch("../../../import.php?data=product", {
        method: 'POST', // *GET, POST, PUT, DELETE, etc.
        mode: 'cors', // no-cors, *cors, same-origin
        cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
        credentials: 'same-origin', // include, *same-origin, omit
        redirect: 'follow', // manual, *follow, error
        referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
        body: JSON.stringify(product, null, 2) // body data type must match "Content-Type" header
      })
      console.log('saved local');
      await fetch("https://proving.aliconnect.nl/import.php?data=product", {
        method: 'POST', // *GET, POST, PUT, DELETE, etc.
        mode: 'cors', // no-cors, *cors, same-origin
        cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
        credentials: 'same-origin', // include, *same-origin, omit
        redirect: 'follow', // manual, *follow, error
        referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
        body: JSON.stringify(product, null, 2) // body data type must match "Content-Type" header
      })
      console.log('saved on server');
    })()
  </script>
</body>
